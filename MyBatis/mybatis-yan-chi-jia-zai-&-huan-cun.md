# 延迟加载

例如学生个人信息, 学生成绩, 学生体检报告, 都分别存放在三张表中, 我们在学生个人信息Mapper 中做了级联. 

当我们获取所生信息是的时候 MyBatis 就会帮我们来查询出该学生的成绩和体检报告. 但是当我们只需要学生的个人成绩时, 如果还查询学生成绩和体检报告, 这样就显得十分多余. 

解决这个问题就可以使用延时加载, 当我们只要学生信息的时候Mybatis 就不会帮我们查询学生成绩和体检报告了, 只有我们要用到的时候才会去查询.

我们使用全局参数 ```lazyLoadingEnabled``` 来开启延迟加载功能.
```
<settings>  
    <setting name="lazyLoadingEnabled" value="true" />  
</settings>  
```
这样当我们使用到某个属性的时候就会帮我们加载数据.

## 延迟加载的层级问题
由于学生成绩和体检报告是一个层级的, 所以我们访问学生成绩的时候也会帮我们查询体检报告. 这样并不是我们想要的, 因为我们只想要学生成绩.

那么我们这个时候就可以使用 ```aggressiveLazyLoading```, 当它为 true(默认值) 的时候, MyBatis 的内容按层级加载, 否则就会按照我们的调用需求加载.
```
<setting name="aggressiveLazyLoading" value="false"/>  
```

## 使用collection或association实现延迟加载
上面的两个设置全部都是全局的, 但是有时候我们并不想这个样子, 我们对一些属性进行立即加载, 有些属性进行延迟加载.

所以我们在级联的时候可以使用 ```fetchType``` 属性设置值为 ```lazy```. 就可以解决上面我们说的情况.

# 缓存 cache
## 一级缓存
MyBatis 对缓存提供支持, 但是在没有配置的默认情况下, 它只开启一级缓存(一级缓存只是相对于同一个 SqlSession 而言).

所以在参数和 SQL 完全一样的情况下, 我们使用同一个 ```SqlSession``` 对象调用同一个 Mapper 的方法, 往往只执行一次 SQL, 因为使用 ```SqlSession``` 第一次查询后, MyBatis 会将其放在缓存中, 以后再查询的时候, 如果没有声明需要刷新, 并且缓存没有超时额度情况下, ```SqlSession``` 都会取出当前缓存的数据, 二不会再查询数据库.

如果使用的是不同的 ```SqlSession``` 对象, 因为不同的 ```SqlSession``` 都是相互隔离的, 它还是会再次发送 sql 语句到数据库中查询.

## 二级缓存
由于每个 ```SqlSession``` 是相互隔离的, 为了解决这个问题我们往往需要配置二级缓存.

使得缓存在 ```SqlSessionFactory``` 层面上能提供各个```SqlSession``` 对象共享.

二级缓存默认是不开启的, 如果要开启二级缓存我们可以使用以下配置来完成, 并且 POJO 必须是可序列化的.
```
<cache/>
```

这个配置中的属性很多都是默认的, 如果我们只是这样配置, 那么就意味着:
 - 映射语句文件中的所有 select 语句将会被缓存.
 - 映射语句文件中的所有 insert,update 和 delete 语句会刷新缓存.
 - 缓存会使用 Least Recently Used(LRU,最近最少使用的)算法来收回.
 - 根据时间表(比如 no Flush Interval,没有刷新间隔), 缓存不会以任何时间顺序来刷新.
 - 缓存会存储列表集合或对象的 1024 个引用, 无论查询方法返回什么.
 - 缓存会被视为是 read/write(可读/可写)的缓存, 意味着对象检索不是共享的, 而且可以安全地被调用者修改, 而不干扰其他调用者或线程所做的潜在修改.

如果我们不想使用默认配置, 我们可以这样修改
```
<cache
  eviction="FIFO"
  flushInterval="60000"
  size="512"
  readOnly="true"/>
```

我们详细说一下属性的意思:
 - eviction: 代表的是缓存回收策略.
 
   - LRU 最近最少使用的: 移除最长时间不被使用的对象(默认).
   - FIFO 先进先出: 按对象进入缓存的顺序来移除它们.
   - SOFT 软引用: 移除基于垃圾回收器状态和软引用规则的对象.
   - WEAK 弱引用: 更积极地移除基于垃圾收集器状态和弱引用规则的对象.
 - flushInterval: 代表刷新间隔, 可以被设置为任意的正整数(毫秒). 默认情况是不设置, 也就是没有刷新间隔, 缓存仅仅调用语句时刷新.
 - size: 引用数目, 一个正整数, 代表缓存最多可以存储多少个对象.
 - readOnly: 只读, 缓存数据只能读取不能修改. 默认为false.
 








